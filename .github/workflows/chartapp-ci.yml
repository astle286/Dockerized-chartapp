name: ChartApp CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  run-tests:
    runs-on: [self-hosted, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

  build-image:
    runs-on: [self-hosted, build]
    needs: run-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t chartapp:latest .

  deploy-preview:
    runs-on: [self-hosted, deploy]
    needs: build-image
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Stop old container (if any)
        run: docker rm -f chartapp || true

      - name: Run container
        run: docker run -d -p 5000:5000 --name chartapp chartapp:latest

      - name: Expose with ngrok
        run: |
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          nohup ngrok http 5000 > ngrok.log &
          sleep 5
          grep -o 'https://[0-9a-z]*\.ngrok.io' ngrok.log > ngrok_url.txt

      - name: Post ngrok URL to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: preview-link
          message: |
            ğŸš€ Your ChartApp preview is live!  
            ğŸŒ URL: $(cat ngrok_url.txt)  
            â³ This preview will auto-expire in 30 minutes.
